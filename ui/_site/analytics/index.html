<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Applicant | ATS-Optimized Resume Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include SweetAlert2 CSS & JS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="icon" href="/logo/logo-icon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="/fonts/inter.css">
    <link rel="stylesheet" href="/css/main.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, #f9fafb, #e5e7eb);
        }
        .hero-gradient {
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        #file-display {
            transition: all 0.3s ease;
        }
        #file-name {
            font-weight: 500;
            color: #2563eb;
        }
        .relative-parent {
            position: relative;
        }
    </style>
    
    
</head>
<body class="min-h-screen">
    <!-- Header/Nav -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo + App Name -->
                <a href="/">
                    <div class="flex items-center">
                        <img src="/logo/logo.svg" alt="Logo Preview" style="border: 1px dashed #ccc">
                        <!-- <span class="ml-2 text-xl font-bold text-gray-900">Smart Applicant</span> -->
                    </div>
                </a>
                
                <!-- Desktop Nav -->
                <nav class="hidden md:flex space-x-8">
                    <a href="/features" class="text-gray-500 hover:text-blue-600 transition">Features</a>
                    <a href="/how_it_works" class="text-gray-500 hover:text-blue-600 transition">How It Works</a>
                    <a href="/dashboard" class="dashboardBtn text-gray-500 hover:text-blue-600 transition hidden">Dashboard</a>
                    <a href="/login" class="loginBtn text-blue-600 hover:text-blue-800 font-medium">Login</a>
                </nav>
                
                <!-- Mobile Menu Button -->
                <button id="main-mobile-menu-toggle" class="md:hidden text-gray-500 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Mobile Menu (Hidden by default) -->
        <div class="md:hidden hidden" id="main-mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="/features" class="block px-3 py-2 text-gray-700 hover:bg-gray-100">Features</a>
                <a href="/how_it_works" class="block px-3 py-2 text-gray-700 hover:bg-gray-100">How It Works</a>
                <a href="/dashboard" class="dashboardBtn block px-3 py-2 text-gray-700 hover:bg-gray-100 hidden">Dashboard</a>
                <a href="/login" class="loginBtn block px-3 py-2 text-blue-600 font-medium">Login</a>
            </div>
        </div>
    </header>
    
    <main>
        
<div class="flex h-full bg-gray-50">
    <!-- Sidebar -->
    <aside class="fixed inset-y-50 left-0 z-50 w-max lg:w-1/5 transform -translate-x-full 
                md:relative md:translate-x-0 transition-transform duration-200 ease-in-out 
                bg-white border-r border-gray-200 overflow-y-auto">
    <div class="flex flex-col w-max bg-white">
        <div class="flex items-center h-16 px-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">Resume Manager</h2>
        </div>
        <nav class="flex-1 px-2 py-4 space-y-1">
            <a href="/dashboard" class="flex items-center px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-md group">
                <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                </svg>
                Dashboard
            </a>
            <a href="/analyze" class="flex items-center px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-md group">
                <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Analyze Resume
            </a>
            <a href="/premium" class="flex items-center px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-md group">
                <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                <span class="flex-1">Go Premium</span>
                <!-- Premium Badge -->
                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gradient-to-r from-purple-500 to-pink-500 text-white">
                    <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5 5a3 3 0 015-2.236A3 3 0 0114.83 6H16a2 2 0 110 4h-5V9a1 1 0 10-2 0v1H4a2 2 0 110-4h1.17C5.06 5.687 5 5.35 5 5zm4 1V5a1 1 0 10-1 1h1zm3 0a1 1 0 10-1-1v1h1z" clip-rule="evenodd"/>
                        <path d="M9 11H3v5a2 2 0 002 2h4v-7zM11 18h4a2 2 0 002-2v-5h-6v7z"/>
                    </svg>
                    PRO
                </span>
            </a>
            <!-- analytics page for admins. must be hidden for regular users. use js to make it visible after dom load-->
            <a href="/analytics" class="flex items-center px-4 py-2 text-sm font-medium text-gray-900 bg-blue-50 rounded-md group hidden" id="analytics-link">
                <svg class="w-5 h-5 mr-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2 2m0 0l4 4m-4-4l4-4m6 6l2 2m0 0l4 4m-4-4l4-4M9 12l2 2m0 0l4 4m-4-4l4-4M15 12l2 2m0 0l4 4m-4-4l4-4"/>
                </svg>
                Analytics
            </a>

            <a href="/profile" class="flex items-center px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-md group">
                <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                Profile
            </a>
            <button type="button" onclick="logoutUser()" class="flex items-center px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-md group">
                <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                Logout
            </button>
        </nav>
    </div>
</aside>
<!-- Overlay (hidden by default) -->
<div id="sidebar-overlay" class="fixed inset-0 z-40 bg-black bg-opacity-50 hidden md:hidden"></div>

<script src="/js/sidebar.js"></script>
<script>
    // Check if the user is an admin and show the analytics link if true
    document.addEventListener('DOMContentLoaded', function() {
        const user = API.getUser();
        const isAdmin = user && user.is_admin;
        const analyticsLink = document.getElementById('analytics-link');
        // console.log('User:', user);
        if (isAdmin) {
            analyticsLink.classList.remove('hidden');
        } else {
            analyticsLink.classList.add('hidden');
        }
    });
</script>

    <!-- Mobile sidebar toggle -->
    <button id="sidebar-toggle" class="md:hidden fixed bottom-4 right-4 bg-blue-600 text-white p-3 rounded-full shadow-lg z-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
    </button>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto">
        <div class="px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Revenue Analytics</h1>
                    <p class="text-gray-600">Track your business performance and revenue streams</p>
                </div>
                <div class="mt-4 md:mt-0 flex space-x-3">
                    <div class="relative">
                        <select id="time-period" class="appearance-none bg-white border border-gray-300 rounded-md pl-3 pr-8 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value=7>Last 7 days</option>
                            <option value=30 selected>Last 30 days</option>
                            <option value=90>Last 90 days</option>
                            <option value=0>This year</option>
                            <option value=1>All time</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                    <button id="excelExporter" class="bg-white border border-gray-300 rounded-md px-3 py-2 text-sm flex items-center">
                        <svg class="h-4 w-4 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Export
                    </button>
                    <button type="button" id="refresh-btn" onclick="toggleRefresh()" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg id="refresh-icon" class="w-5 h-5 mr-2 text-green-500 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span id="refresh-text">Refresh</span>
                    </button>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Revenue -->
                <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500" id="total-revenue-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Revenue</p>
                            <p class="text-2xl font-semibold text-gray-900 metric-value">$24,780</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <p class="mt-2 text-sm text-green-600 font-medium growth-indicator">
                        <span>↑ 12.5%</span>
                        <span class="text-gray-500 ml-1">vs last period</span>
                    </p>
                </div>

                <!-- Credit Purchases -->
                <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500" id="credit-purchases-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Credit Purchases</p>
                            <p class="text-2xl font-semibold text-gray-900 metric-value">$8,450</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                    </div>
                    <p class="mt-2 text-sm text-green-600 font-medium growth-indicator">
                        <span>↑ 8.2%</span>
                        <span class="text-gray-500 ml-1">vs last period</span>
                    </p>
                </div>

                <!-- Subscriptions -->
                <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500" id="subscriptions-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Subscriptions</p>
                            <p class="text-2xl font-semibold text-gray-900 metric-value">$16,330</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                            </svg>
                        </div>
                    </div>
                    <p class="mt-2 text-sm text-green-600 font-medium growth-indicator">
                        <span>↑ 15.7%</span>
                        <span class="text-gray-500 ml-1">vs last period</span>
                    </p>
                </div>

                <!-- Active Users -->
                <div class="bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500" id="active-users-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Active Users</p>
                            <p class="text-2xl font-semibold text-gray-900 metric-value">1,842</p>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-full">
                            <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <p class="mt-2 text-sm text-green-600 font-medium growth-indicator">
                        <span>↑ 5.3%</span>
                        <span class="text-gray-500 ml-1">vs last period</span>
                    </p>
                </div>
            </div>

            <!-- Revenue Breakdown -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8" id="revenue-by-plan-chart">
                <!-- Revenue Chart -->
                <div class="bg-white rounded-lg shadow p-6 lg:col-span-2">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold text-gray-900">Revenue Overview</h2>
                        <div class="flex space-x-2">
                            <button class="px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded-md">Monthly</button>
                            <button class="px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded-md">Quarterly</button>
                            <button class="px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded-md">Yearly</button>
                        </div>
                    </div>
                    <div class="h-80">
                        <!-- Chart would be rendered here -->
                        <canvas id="revenueChartVisualization"></canvas>
                    </div>
                </div>

                <!-- Revenue by Plan -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-6">Revenue by Plan</h2>
                    <div class="space-y-6 revenue-items">
                        <!-- 1 Month -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">1 Month</span>
                                <span class="text-sm font-medium text-gray-900">$5,240 (21%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: 21%"></div>
                            </div>
                        </div>
                        
                        <!-- 3 Months -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">3 Months</span>
                                <span class="text-sm font-medium text-gray-900">$7,860 (32%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-green-600 h-2 rounded-full" style="width: 32%"></div>
                            </div>
                        </div>
                        
                        <!-- 6 Months -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">6 Months</span>
                                <span class="text-sm font-medium text-gray-900">$8,120 (33%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-purple-600 h-2 rounded-full" style="width: 33%"></div>
                            </div>
                        </div>
                        
                        <!-- 1 Year -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">1 Year</span>
                                <span class="text-sm font-medium text-gray-900">$3,560 (14%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-yellow-600 h-2 rounded-full" style="width: 14%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Total Subscription Revenue</h3>
                        <p class="text-2xl font-semibold text-gray-900">$16,330</p>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="bg-white rounded-lg shadow overflow-hidden mb-8" id="recent-transactions">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Recent Transactions</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plan</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">May 24, 2023</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <img class="h-10 w-10 rounded-full" src="https://randomuser.me/api/portraits/women/32.jpg" alt="">
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900">Sarah Johnson</div>
                                            <div class="text-sm text-gray-500">sarah@example.com</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Subscription</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">3 Months</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$24.99</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Completed</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">May 23, 2023</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <img class="h-10 w-10 rounded-full" src="https://randomuser.me/api/portraits/men/42.jpg" alt="">
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900">Michael Brown</div>
                                            <div class="text-sm text-gray-500">michael@example.com</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Credits</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">5 Credits</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$5.00</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Completed</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">May 22, 2023</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <img class="h-10 w-10 rounded-full" src="https://randomuser.me/api/portraits/women/68.jpg" alt="">
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900">Jessica Wilson</div>
                                            <div class="text-sm text-gray-500">jessica@example.com</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Subscription</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">1 Year</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$89.99</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Additional Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- MRR Growth -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Monthly Recurring Revenue (MRR)</h2>
                    <div class="h-64">
                        <canvas id="mrrGrowthChart"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-3 gap-4">
                        <div class="text-center">
                            <p class="text-sm text-gray-500">New MRR</p>
                            <p id="newMrrValue" class="text-lg font-semibold text-green-600">$2,450</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-500">Expansion MRR</p>
                            <p id="expansionMrrValue" class="text-lg font-semibold text-blue-600">$1,120</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-500">Churned MRR</p>
                            <p id="churnedMrrValue" class="text-lg font-semibold text-red-600">$780</p>
                        </div>
                    </div>
                </div>

                <!-- Customer Acquisition -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Customer Acquisition</h2>
                    <div class="h-64">
                        <canvas id="customerAcquisitionChart"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <p class="text-sm text-gray-500">New Customers</p>
                            <p id="newCustomersValue" class="text-lg font-semibold text-gray-900">142</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-500">Avg. CAC</p>
                            <p id="avgCacValue" class="text-lg font-semibold text-gray-900">$8.50</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Plan Performance -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Plan Performance</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="plan-performance-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plan</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subscribers</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MRR</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg. Lifetime</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Churn Rate</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conversion</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">1 Month</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">328</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$3,280</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2.4 months</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <span class="text-red-600">12.5%</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">8.2%</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">3 Months</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">215</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$5,375</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">5.1 months</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <span class="text-yellow-600">8.3%</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">6.7%</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">6 Months</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">178</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$8,900</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">8.7 months</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <span class="text-green-600">5.2%</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">5.1%</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">1 Year</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">92</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$9,200</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">14.2 months</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <span class="text-green-600">3.1%</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">3.8%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
    let isRefreshing = false;
    let autoRefreshInterval = null;
    let currency = {'symbol': '$', 'code': 'USD'}; // Default currency, can be set dynamically
    let dashboardData = {}; // Store fetched dashboard data
// This is where you would integrate with your actual analytics API
document.addEventListener('DOMContentLoaded', function() {
    const user = API.getUser(); 
    // Check if the user is an admin
    if (!user || !user.is_admin) {
        window.location.href = '/dashboard'; // Redirect if not admin
    }
    
    // Default to 30 days
    fetchDashboardData(30);
    
    // Time period selector event listener
    document.querySelector('#time-period').addEventListener('change', (e) => {
        var duration = parseInt(e.target.value);
        if (duration === 0) {
            // Convert "This year" to actual days
            duration = getDaysThisYear();
        }
        // console.log(`Fetching data for the last ${duration} days`);
        fetchDashboardData(duration);
    });

    document.getElementById('excelExporter').addEventListener('click', () => {
        // Export dashboard data to Excel
        if (dashboardData && Object.keys(dashboardData).length > 0) {
            exportAnalyticsDataToExcel(dashboardData);
        } else {
            showToast('No data available to export', 'error');
        }
    });
    
    // You would typically integrate chart libraries like Chart.js here
    // For example:
    // const revenueChart = new Chart(document.getElementById('revenue-chart'), { ... });
});

function toggleRefresh() {
    if (isRefreshing) {
        // If already refreshing, stop the refresh
        stopRefresh();
    } else {
        // Start manual refresh
        startRefresh();
    }
}

function startRefresh() {
    if (isRefreshing) return;
    
    isRefreshing = true;
    updateRefreshButtonUI();
    
    // Perform the actual data refresh
    refreshDashboardData()
        .then(() => {
            // delay for 2 seconds to simulate loading
            setTimeout(() => {
                stopRefresh();
            }, 2000);
        })
        .catch(error => {
            console.error('Refresh failed:', error);
            stopRefresh();
            // Optionally show error to user
        });
}

function stopRefresh() {
    isRefreshing = false;
    updateRefreshButtonUI();
    
    // If you have auto-refresh running, you might not want to stop it here
    // stopAutoRefresh();
}

function updateRefreshButtonUI() {
    const refreshIcon = document.getElementById('refresh-icon');
    const refreshText = document.getElementById('refresh-text');
    const refreshBtn = document.getElementById('refresh-btn');
    
    if (isRefreshing) {
        // Add spinning animation and hide text
        refreshIcon.classList.add('animate-spin');
        refreshText.classList.add('hidden');
        refreshBtn.setAttribute('disabled', 'disabled');
        refreshBtn.classList.remove('hover:bg-gray-50');
    } else {
        // Remove spinning animation and show text
        refreshIcon.classList.remove('animate-spin');
        refreshText.classList.remove('hidden');
        refreshBtn.removeAttribute('disabled');
        refreshBtn.classList.add('hover:bg-gray-50');
    }
}

async function refreshDashboardData() {
    // Get the current time period selection
    const timePeriodSelect = document.getElementById('time-period');
    var days = timePeriodSelect.value;
    if (timePeriodSelect.value == 0) {
        days = getDaysThisYear(); // Convert "This year" to actual days
    }
    // console.log(`Refreshing dashboard data for the last ${days} days...`);
    
    // Call your existing update function
    return fetchDashboardData(days);
}

// Optional auto-refresh functions
function startAutoRefresh(intervalMs) {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    autoRefreshInterval = setInterval(() => {
        if (!isRefreshing) {
            startRefresh();
        }
    }, intervalMs);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// Helper function (same as before)
function getDaysThisYear() {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 0);
    const diff = now - start;
    return Math.floor(diff / (1000 * 60 * 60 * 24));
}

async function fetchDashboardData(durationDays = 30) {
    try {
        const response = await API.request(`/api/analytics/${durationDays}/`, 'GET');
        if (!response.ok) throw new Error(response.statusText);
        const data = await response.json();
        
        if (data.status !== 1) {
            throw new Error(data.message || 'Failed to fetch dashboard data');
        }
        // update currency if provided and dashboard data
        currency = data.data.currency || currency;
        dashboardData = data.data; // Store the fetched data globally

        console.log('Dashboard data fetched successfully: ', JSON.stringify(data.data, null, 2));

        // Process and populate the dashboard with the received data
        populateDashboard(data.data);
        
        return data;
    } catch (error) {
        console.error('Error fetching dashboard data:', error);
        // Show error to user
        showToast(error.message, 'error');
    }
}

function populateDashboard(data) {
    // Update the key metrics cards
    updateMetricCard('#total-revenue-card', data.total_revenue, data.growth_rates.total_revenue);
    updateMetricCard('#credit-purchases-card', data.credit_purchases.total_revenue, data.growth_rates.credit_purchases);
    updateMetricCard('#subscriptions-card', data.subscriptions.total_revenue, data.growth_rates.subscriptions);
    updateMetricCard('#active-users-card', data.active_users, data.growth_rates.active_users);
    
    // Update revenue by plan chart
    updateRevenueByPlanChart(data.subscriptions.by_plan);
    
    // Update recent transactions table
    updateRecentTransactions(data.recent_orders);
    
    // // Update payment method distribution
    // updatePaymentMethodDistribution(data.payment_methods);

    // Update MRR growth chart
    updateMRRChart(data.mrr_breakdown);

    // // Update customer acquisition chart
    updateCustomerAcquisitionChart(data.customer_acquisition);

    // Update Plan Performance table
    updatePlanPerformanceTable(data.plan_performance);
}

function updateMetricCard(selector, value, growthRate) {
    const card = document.querySelector(selector);
    if (!card) return;
    
    // Update value
    const valueEl = card.querySelector('.metric-value');
    if (valueEl) {
        // valueEl.textContent = typeof value === 'number' ? `${currency.symbol}${value.toLocaleString()}` : value;
        valueEl.textContent = selector !== '#active-users-card' ? `${currency.symbol}${value.toLocaleString()}` : value;
    }
    
    // Update growth indicator
    const growthEl = card.querySelector('.growth-indicator');
    if (growthEl) {
        const isPositive = growthRate >= 0;
        growthEl.innerHTML = `
            <span class="${isPositive ? 'text-green-600' : 'text-red-600'}">
                ${isPositive ? '↑' : '↓'} ${Math.abs(growthRate)}%
            </span>
            <span class="text-gray-500 ml-1">vs previous period</span>
        `;
    }
}

function updateRevenueByPlanChart(data) {
    const container = document.getElementById('revenue-by-plan-chart');
    if (!container) return;

    // Create canvas for chart if it doesn't exist
    let chartCanvas = container.querySelector('canvas');
    if (!chartCanvas) {
        chartCanvas = document.createElement('canvas');
        chartCanvas.height = 200;
        const chartContainer = document.createElement('div');
        chartContainer.className = 'h-64 mt-6';
        chartContainer.appendChild(chartCanvas);
        container.insertBefore(chartContainer, container.querySelector('.mt-8'));
    }

    // Map plan keys to display names and colors
    const planConfig = {
        'one_month_subscription': { label: '1 Month', color: '#3B82F6' },
        'three_months_subscription': { label: '3 Months', color: '#10B981' },
        'six_months_subscription': { label: '6 Months', color: '#8B5CF6' },
        'one_year_subscription': { label: '1 Year', color: '#F59E0B' },
        'resume_credit': { label: 'Resume Credits', color: '#6366F1' }
    };

    // Filter and sort plans by revenue (descending)
    const activePlans = Object.entries(data)
        .filter(([_, planData]) => planData.revenue > 0)
        .sort((a, b) => b[1].revenue - a[1].revenue);

    // If no plans have revenue, show at least one for context
    if (activePlans.length === 0) {
        activePlans.push(['one_month_subscription', { revenue: 0, percentage: 0 }]);
    }

    // Calculate total revenue
    const totalRevenue = activePlans.reduce((sum, [_, planData]) => sum + planData.revenue, 0);

    // Update progress bars
    const contentDiv = container.querySelector('.space-y-6');
    if (contentDiv) {
        contentDiv.innerHTML = '';
        
        activePlans.forEach(([planKey, planData]) => {
            const config = planConfig[planKey] || { 
                label: planKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                color: '#9CA3AF' 
            };
            
            const percentage = totalRevenue > 0 ? 
                Math.round((planData.revenue / totalRevenue) * 100) : 
                0;

            const planElement = document.createElement('div');
            planElement.innerHTML = `
                <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-gray-700">${config.label}</span>
                    <span class="text-sm font-medium text-gray-900">
                        ${currency.symbol}${planData.revenue.toLocaleString()} (${percentage}%)
                    </span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="h-2 rounded-full" 
                         style="width: ${percentage}%; background-color: ${config.color}">
                    </div>
                </div>
            `;
            contentDiv.appendChild(planElement);
        });
    }

    // Update total revenue display
    const totalElement = container.querySelector('.text-2xl.font-semibold.text-gray-900');
    if (totalElement) {
        totalElement.textContent = `${currency.symbol}${totalRevenue.toLocaleString()}`;
    }

    // Initialize or update chart
    if (typeof Chart !== 'undefined') {
        const ctx = chartCanvas.getContext('2d');
        
        // Destroy previous chart if exists
        if (chartCanvas.chart) {
            chartCanvas.chart.destroy();
        }

        // Prepare chart data
        const chartData = {
            labels: activePlans.map(([planKey]) => planConfig[planKey]?.label || planKey),
            datasets: [{
                data: activePlans.map(([_, planData]) => planData.revenue),
                backgroundColor: activePlans.map(([planKey]) => planConfig[planKey]?.color || '#9CA3AF'),
                borderWidth: 0
            }]
        };

        // Create chart
        chartCanvas.chart = new Chart(ctx, {
            type: activePlans.length <= 3 ? 'doughnut' : 'pie',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: activePlans.length <= 3 ? '70%' : '0%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'circle',
                            padding: 20,
                            font: {
                                family: 'Inter, sans-serif'
                            },
                            generateLabels: (chart) => {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => ({
                                        text: `${label} - ${currency.symbol}${data.datasets[0].data[i].toLocaleString()}`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    }));
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${currency.symbol}${value.toLocaleString()} (${percentage}%)`;
                            }
                        }
                    }
                },
                layout: {
                    padding: activePlans.length > 5 ? 10 : 5
                }
            }
        });
    }
}

function updateRecentTransactions(transactions) {
    const tableBody = document.querySelector('#recent-transactions tbody');
    if (!tableBody) return;
    
    tableBody.innerHTML = transactions.map(transaction => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${formatDate(transaction.created_at)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">
                            ${transaction.user__first_name} ${transaction.user__last_name}
                        </div>
                        <div class="text-sm text-gray-500">
                            ${transaction.user__email}
                        </div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${transaction.order_type}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${transaction.order_type === 'CREDIT' ? `${transaction.quantity} Credits` : getSubText(transaction.subscription__subscription_type__name) || 'N/A'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${currency.symbol}${transaction.total}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                    ${transaction.payment_status === 'PAID' ? 'bg-green-100 text-green-800' : 
                      transaction.payment_status === 'PENDING' ? 'bg-yellow-100 text-yellow-800' : 
                      'bg-red-100 text-red-800'}">
                    ${transaction.payment_status}
                </span>
            </td>
        </tr>
    `).join('');
}

function getSubText(plan){
    switch(plan){
        case 'one_month_subscription':
            return '1 Month';
        case 'three_months_subscription':
            return '3 Months';
        case 'six_months_subscription':
            return '6 Months';
        case 'one_year_subscription':
            return '1 Year';
        case 'credits':
            return 'Credits';
        default:
            return 'Unknown Plan';
    }
}

function updatePaymentMethodDistribution(methods) {
    // Update payment method distribution chart or table
    const container = document.querySelector('#payment-methods-distribution');
    if (!container) return;
    
    // Example for a simple table display
    container.innerHTML = `
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Orders</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                ${Object.entries(methods.revenue).map(([method, revenue]) => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${method}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${currency.symbol}${revenue.toLocaleString()}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${methods.count[method] || 0}
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// Customer Acquisition Chart Implementation
function updateCustomerAcquisitionChart(data) {
    const ctx = document.getElementById('customerAcquisitionChart');
    if (!ctx) return;
    
    // Update the metrics
    document.getElementById('newCustomersValue').textContent = data.new_customers;
    document.getElementById('avgCacValue').textContent = 
        `${currency.symbol}${data.cac.toFixed(2)}`;

    // Destroy previous chart if exists
    if (ctx.chart) {
        ctx.chart.destroy();
    }

    // Create new chart
    ctx.chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Organic', 'Paid Ads', 'Referrals', 'Social Media', 'Email'],
            datasets: [{
                label: 'New Customers',
                data: data.channels,
                backgroundColor: [
                    'rgba(59, 130, 246, 0.7)',
                    'rgba(16, 185, 129, 0.7)',
                    'rgba(139, 92, 246, 0.7)',
                    'rgba(236, 72, 153, 0.7)',
                    'rgba(234, 179, 8, 0.7)'
                ],
                borderColor: [
                    'rgba(59, 130, 246, 1)',
                    'rgba(16, 185, 129, 1)',
                    'rgba(139, 92, 246, 1)',
                    'rgba(236, 72, 153, 1)',
                    'rgba(234, 179, 8, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    },
                    title: {
                        display: true,
                        text: 'Number of Customers'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function updateMRRChart(data) {
    const ctx = document.getElementById('mrrGrowthChart');
    if (!ctx) return;
    
    // Update the metrics with percentage changes
    document.getElementById('newMrrValue').textContent = 
        `${currency.symbol}${data.new.amount.toLocaleString()} (${data.new.percent >= 0 ? '↑' : '↓'} ${Math.abs(data.new.percent)}%)`;
    document.getElementById('expansionMrrValue').textContent = 
        `${currency.symbol}${data.expansion.amount.toLocaleString()} (${data.expansion.percent >= 0 ? '↑' : '↓'} ${Math.abs(data.expansion.percent)}%)`;
    document.getElementById('churnedMrrValue').textContent = 
        `${currency.symbol}${data.churned.amount.toLocaleString()} (${data.churned.percent >= 0 ? '↑' : '↓'} ${Math.abs(data.churned.percent)}%)`;

    // Destroy previous chart if exists
    if (ctx.chart) {
        ctx.chart.destroy();
    }

    // Prepare datasets - handle cases with only 1 month of data
    const datasets = [
        {
            label: 'Total MRR',
            data: data.months.map((_, i) => {
                // For single month, show current total
                if (data.months.length === 1) return data.total_mrr;
                // For multiple months, calculate running total
                return data.new_mrr_data.slice(0, i+1).reduce((a,b) => a + b, 0) +
                       (data.expansion.amount - data.churned.amount) * (i / (data.months.length - 1));
            }),
            borderColor: 'rgba(79, 70, 229, 1)',
            backgroundColor: 'rgba(79, 70, 229, 0.05)',
            borderWidth: 2,
            fill: true,
            tension: data.months.length > 1 ? 0.3 : 0 // No tension for single point
        },
        {
            label: 'New MRR',
            data: data.new_mrr_data,
            borderColor: 'rgba(16, 185, 129, 1)',
            backgroundColor: 'rgba(16, 185, 129, 0.05)',
            borderWidth: 2,
            borderDash: data.months.length > 1 ? [5, 5] : [], // No dashes for single point
            tension: data.months.length > 1 ? 0.3 : 0
        }
    ];

    // Create new chart
    ctx.chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.months,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${currency.symbol}${context.raw.toLocaleString()}`;
                        },
                        footer: function(tooltipItems) {
                            if (data.months.length === 1) {
                                return `Total MRR: ${currency.symbol}${data.total_mrr.toLocaleString()}`;
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: data.months.length === 1 ? false : true,
                    ticks: {
                        callback: function(value) {
                            return currency.symbol + value.toLocaleString();
                        }
                    },
                    title: {
                        display: true,
                        text: 'MRR Amount'
                    }
                },
                x: {
                    grid: {
                        display: data.months.length > 1
                    }
                }
            },
            elements: {
                point: {
                    radius: data.months.length === 1 ? 6 : 3,
                    hoverRadius: data.months.length === 1 ? 8 : 5
                }
            }
        }
    });
}

function updatePlanPerformanceTable(planPerformance) {
    const tableBody = document.querySelector('#plan-performance-table tbody');
    if (!tableBody) return;
    
    tableBody.innerHTML = planPerformance.map(plan => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${getSubText(plan.plan)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${plan.subscribers}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${currency.symbol}${plan.mrr.toLocaleString()}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${plan.avg_lifetime} months</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <span class="${plan.churn_rate >= 0 ? 'text-red-600' : 'text-green-600'}">
                    ${Math.abs(plan.churn_rate)}%
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${plan.conversion_rate}%</td>
        </tr>
    `).join('');
}

// Helper function to format dates
function formatDate(dateString) {
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(dateString).toLocaleDateString(undefined, options);
}

</script>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-300 py-12 px-4">
        <div class="max-w-7xl mx-auto">
            <div class="grid md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-white font-bold text-lg mb-4">Smart Applicant</h3>
                    <p class="mb-4">The most advanced ATS optimization tool for job seekers.</p>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-white">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"></path></svg>
                        </a>
                        <!-- Add other social icons -->
                    </div>
                </div>
                <div>
                    <h4 class="text-white font-semibold mb-4">Product</h4>
                    <ul class="space-y-2">
                        <li><a href="/features" class="hover:text-white">Features</a></li>
                        <li><a href="/how_it_works" class="hover:text-white">How It Works</a></li>
                        <!-- <li><a href="#" class="hover:text-white">Pricing</a></li> -->
                        <!-- <li><a href="#" class="hover:text-white">FAQ</a></li> -->
                    </ul>
                </div>
                <div>
                    <h4 class="text-white font-semibold mb-4">Company</h4>
                    <ul class="space-y-2">
                        <li><a href="/about" class="hover:text-white">About</a></li>
                        <li><a href="/blog" class="hover:text-white">Blog</a></li>
                        <li><a href="/careers" class="hover:text-white">Careers</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-white font-semibold mb-4">Legal</h4>
                    <ul class="space-y-2">
                        <li><a href="/privacy" class="hover:text-white">Privacy Policy</a></li>
                        <li><a href="/tos" class="hover:text-white">Terms of Service</a></li>
                        <li><a href="/cookie" class="hover:text-white">Cookie Policy</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-800 mt-8 pt-8 text-sm text-center">
                <div>
                    Registered Users: <span id="registered-users-count">0</span>
                </div>
                <div>
                    Premium Subscribers: <span id="premium-subscribers-count">0</span>
                </div>
                <div>
                    Currently Online: <span id="online-users-count">0</span>
                </div>
                <p>© 2025 Smart Applicant. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- paystack js -->
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/upload.js"></script>
    <script src="/js/poll.js"></script>
    <script src="/js/task.js"></script>
    <script src="/js/user/queryBackend.js"></script>
    <script src="/js/user/auth.js"></script>
    <script src="/js/paystack.js"></script>

    <!-- display mobile menu on click -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Listen for storage changes from other tabs
            window.addEventListener('storage', (event) => {
                if (['access_token', 'refresh_token', 'user'].includes(event.key)) {
                    API.initialize();
                }
            });
                
            if (API.isAuthenticated()) {
                document.querySelectorAll('.dashboardBtn').forEach(el => el.classList.remove('hidden'));
                document.querySelectorAll('.loginBtn').forEach(el => el.classList.add('hidden'));
            } else {
                document.querySelectorAll('.dashboardBtn').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.loginBtn').forEach(el => el.classList.remove('hidden'));
            }


            const mobileMenuButton = document.getElementById('main-mobile-menu-toggle');
            const mobileMenu = document.getElementById('main-mobile-menu');
            
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
        });

        function toggleSpinner() {
            const spinner = document.getElementById('spinner');
            const btnText = document.getElementById('btn-text');
            
            if (spinner.classList.contains('hidden')) {
                spinner.classList.remove('hidden');
                btnText.textContent = 'Uploading...';
            } else {
                spinner.classList.add('hidden');
                btnText.textContent = 'Upload';
            }
        }
        
    </script>
     
    
</body>
</html>